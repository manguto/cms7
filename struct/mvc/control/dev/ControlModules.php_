<?php
namespace cms\control\dev;


use cms\control\Control;
use cms\view\dev\ViewModules;
use cms\model\User_module;

class ControlModules extends Control
{
    
    static function RunRouteAnalisys($app)
    {
        $app->get('/dev/modules', function () {
            self::PrivativeDevZone();
            ViewModules::modules();
        });
        
        $app->get('/dev/modules/:action/:key', function ($action,$key) {
            self::PrivativeDevZone();
            /*deb($action,0);
            deb($key);/**/
            {
                $key_array = explode('___', $key);
                $user_id = $key_array[0];
                $module = $key_array[1];
                $nature = $key_array[2];
            }
            
            {//remocao de todos os perfis do usuario para um determinado modulo
                $query = " \$user_id==$user_id && \$module=='$module' ";
                $um_array = (new User_module())->search($query);
                if(sizeof($um_array)>0){
                    foreach ($um_array as $um){
                        $um->delete();
                    }
                }
            }
            
            {//insercao do perfil informado
                if($action=='set'){
                    $um = new User_module();
                    $um->setUser_id($user_id);
                    $um->setModule($module);
                    $um->setNature($nature);
                    $um->save();                 
                }
            }                                    

            CMS::headerLocation('/dev/modules');
        });
        
    }
}

?>